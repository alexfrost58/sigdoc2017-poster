<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>D3 Demos</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
      <script src="https://d3js.org/d3-selection.v1.min.js"></script>
      <script src="https://d3js.org/d3-dsv.v1.min.js"></script>
  </head>
  <body>
    <svg width="1000" height="400" style="border: 1px solid">
    </svg>
      
    <script>
       (function(d3) {
           'use strict';
        
        var x1, x2, y1, y2;
           x1 = 0;
           x2 = 0;
           y1 = y2 = 200;
           
        var accumulatedData = 0;
        var newMark = 0;
         
        var difference = 80; // for test
        var optimal = 20;
        var initialX = 100;
        var initialY = 300;
           
        d3.csv('VIZdata2.csv', function(error, dataset) {           
          dataset.forEach(function(d) {                             
            d.difference = d.difference*100;                                 
          }); 
            
        var xScale = d3.scaleLinear()
                     .domain([0, 200000])
                     .range([0, 1000]);

        var drawcircles = d3.selectAll("svg")
          .selectAll("circle")
          .data(dataset)
          .enter()
          .append("circle")
            //.attr("cx", function(d){return (d.difference+"px");})
            .attr("cx", function(d, i){
                return (d.difference+"px");})
            .attr("cy", function(d, i){
                var subject = d.Subject;
                var subjectNumber = +subject.slice(1); // remove "S" from S0 and turn it into number
                
                return (10+subjectNumber*10+"px");})
            .attr("r", "2px")
            .style("stroke", "red")
            .style("opacity", "0.5");
            
        drawcircles.attr("cx", function(d,i){    
            accumulatedData = 0;
      
            var currentData = drawcircles.data()[i];
            var prevData = i>0?drawcircles.data()[i-1]:drawcircles.data()[drawcircles.data().length-1];
            
            var subject = currentData.Subject;
            var subjectNumber = +subject.slice(1); 
            
            var prevSubject = prevData.Subject;
            var prevSubjectNumber = +prevSubject.slice(1); 
            
            if(subjectNumber === prevSubjectNumber) {
               for (var j = i; j > newMark; j--) {
                    currentData = drawcircles.data()[j];
                    accumulatedData += currentData.difference;  
                }
            } else {
                accumulatedData = 0;
                newMark = i;
            }
            
            return (accumulatedData+"px");});
        
            //return (currentData.difference + prevData.difference+"px");}) 
          
          // testing the curves, bezier : not perfect yet
            var drawCurves = 
                d3.select("svg")
                //.selectAll("path")
                .selectAll("path")
                .data(dataset)
                .enter()
                .append("path")
                  .attr("d", "M " + initialX + " " + initialY + " " + "q " + optimal/2 + " " + (optimal - difference)/optimal * 10 + " " + optimal + " 0")
                  .style("stroke", "red")
                  .style("stroke-width", "1")
                  .style("fill", "none")
                  .style("opacity", "0.5");
            
            drawCurves.attr("d", function(d, i) { // needs optimization
                accumulatedData = 0;
            
                var currentData = drawCurves.data()[i];
                var prevData = i>0?drawCurves.data()[i-1]:drawCurves.data()[drawCurves.data().length-1];

                var subject = currentData.Subject;
                var subjectNumber = +subject.slice(1); 

                var prevSubject = prevData.Subject;
                var prevSubjectNumber = +prevSubject.slice(1); 

                difference = currentData.difference * 3;
                optimal = currentData.difference;
                
                if(subjectNumber === prevSubjectNumber) {

                   for (var j = i; j > newMark; j--) {
                        currentData = drawCurves.data()[j];
                        accumulatedData += currentData.difference;  
                    }
                } else {
                    accumulatedData = 0;
                    newMark = i;
                }
                
                initialX = accumulatedData;
                
                var subject = d.Subject;
                var subjectNumber = +subject.slice(1); 
                
                initialY = 100+subjectNumber*10;
                
                return ("M " + initialX + " " + initialY + " " + "q " + optimal/2 + " " + (optimal - difference)/optimal * 100 + " " + optimal + " 0");
                
            });
        

            });
    })(window.d3);
           
       
    </script>
      
  </body>
</html>
